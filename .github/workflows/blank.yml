
on:
  push:
    branches:
      - master

name: Deploy to Amazon EKS

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v1

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: AKIATPZP3QVYSXK5UOPW
        aws-secret-access-key: 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
        aws-region: us-east-2
    - name: Deploy k8s yaml

      run: |
        aws eks create-cluster --name Cluster-demo \
        --role-arn arn:aws:iam::240081667441:role/Aws \
        --resources-vpc-config subnetIds=subnet-03c011d8e59dadebc,subnet-092138c353feed8d7,securityGroupIds=sg-03553a948d763e792
    - name: pod kubctl version
      run: |
       kubectl version --client=true \ 
       pwd 

    - name: Dormir por 3 minutos
      uses: jakejarvis/wait-action@master
      with:
        time: '900s'
        
       
    - name: pod apply
      run: |
       aws eks --region us-east-2 update-kubeconfig --name Cluster-demo &&
       kubectl config view && kubectl get svc && mkdir -p ~/.kube && kubectl apply -f https://k8s.io/examples/application/deployment.yaml && kubectl describe deployment nginx-deployment && kubectl get pods -l app=nginx
 
    - name: pelea
      run: |
       kubectl describe deployment nginx-deployment && kubectl get pods -l app=nginx
    - name: Crear node-group
      
      run: |
       aws eks create-nodegroup --cluster-name=Cluster-demo --nodegroup-name=pepe --subnets=subnet-05226b7df7a7f93a7 --node-role=arn:aws:iam::343942719020:role/Clave-valor
